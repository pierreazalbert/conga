var $jscomp={scope:{},executeAsyncGenerator:function(a){function e(b){return a.next(b)}function b(b){return a["throw"](b)}return new Promise(function(c,d){function m(a){a.done?c(a.value):Promise.resolve(a.value).then(e,b).then(m,d)}m(a.next())})}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,e,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[e]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var e=0;return $jscomp.iteratorPrototype(function(){return e<a.length?{done:!1,value:a[e++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var e=a[Symbol.iterator];return e?e.call(a):$jscomp.arrayIterator(a)};
$jscomp.polyfill=function(a,e,b,c){if(e){b=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var d=a[c];d in b||(b[d]={});b=b[d]}a=a[a.length-1];c=b[a];e=e(c);e!=c&&null!=e&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:e})}};$jscomp.EXPOSE_ASYNC_EXECUTOR=!0;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.findInternal=function(a,e,b){a instanceof String&&(a=String(a));for(var c=a.length,d=0;d<c;d++){var m=a[d];if(e.call(b,m,d,a))return{i:d,v:m}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
$(document).ready(function(){return $jscomp.executeAsyncGenerator(function(){function a(a,h){for(;;)switch(e){case 0:return g=getParams(window.location.href).key,e=1,{value:getShopData(g),done:!1};case 1:if(void 0===h){e=2;break}e=-1;throw h;case 2:return d=m=a,$("#shop-name").text(d.data().name),$("#shop-code").prepend("@"+d.data()["short"]),$("#shop-link").prop("href","/book?shop="+d.data().code),$("[name=today]").text(moment().format("dddd Do MMMM")),e=3,{value:db.collection("tickets").where("shop",
"==",d.id).where("date","==",moment().format("DD/MM/YYYY")).get(),done:!1};case 3:if(void 0===h){e=4;break}e=-1;throw h;case 4:b=c=a;if(b.empty)console.log("No bookings found for this shop!"),$("#all-bookings").empty().append('<div class="col-12 mb-2 d-flex justify-content-center"><label class="w-100 btn btn-grey btn-conga nohover btn-lg">No bookings found for today</label></div>'),$("#get-schedule").hide();else{console.log("Found following bookings: ",b.docs);var l=b.docs.slice();l.sort(function(b,
a){return moment(b.data().time,"HH:mm")-moment(a.data().time,"HH:mm")});renderQueue(d.data(),l);renderBookings(l);makeSchedulePDF(d,l);if("auto"==d.data().status){$("#next-booking").click();var k=setInterval(function(){renderQueue(d.data(),l);renderBookings(l)},1E4)}else $("#next-customer").click()}$("#toggle-queue").change(function(b){return $jscomp.executeAsyncGenerator(function(){function b(b,f){for(;;)switch(a){case 0:if("next-booking"!=$(":checked").attr("id")){a=1;break}console.log("Switching to automatic queue control");
a=3;return{value:updateShopQueueStatus(d,"auto"),done:!1};case 3:if(void 0===f){a=4;break}a=-1;throw f;case 4:d=e=b;renderQueue(d.data(),l);renderBookings(l);k=setInterval(function(){renderQueue(d.data(),l);renderBookings(l)},1E4);a=2;break;case 1:if("next-customer"!=$(":checked").attr("id")){a=5;break}console.log("Switching to manual queue control");a=6;return{value:updateShopQueueStatus(d,"manual"),done:!1};case 6:if(void 0===f){a=7;break}a=-1;throw f;case 7:d=c=b,renderQueue(d.data(),l),clearInterval(k);
case 5:case 2:a=-1;default:return{value:void 0,done:!0}}}var a=0,c,e,f={next:function(a){return b(a,void 0)},"throw":function(a){return b(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())});renderShopSettings(d);$(":button[name=settings]").click(function(){$("#shop-settings").load("signup.html form",function(){$("#shop-settings").addClass("mb-5");$("form > :submit").text("Save shop settings");
$("form").find("#email").parent().parent().prev().remove();$("form").find("#email").parent().parent().next().remove();$("form").find("#email").parent().parent().remove();$("form").find(".text-muted").remove();$(":checkbox").change(function(){$(this).parent().parent().parent().find("input[type='time']").prop("disabled",function(a,b){return!b})});$("form").find("#name").val(d.data().name);$("form").find("#address").val(d.data().address);$("form").find("#short").val(d.data()["short"]);$.each(d.data().hours,
function(a,b){"closed"==b?$("form").find("#"+a+"-closed").click():($("form").find("#"+a+"-open").val(b.open),$("form").find("#"+a+"-close").val(b.close))});$("form").find("#number").val(d.data().bookings.number);$("form").find("#rate").val(d.data().bookings.rate);$("form").find("input[name=control][value="+d.data().control+"]").prop("checked",!0);$("input[type=time]").change(function(){checkTimeInput(this)});$("input[id=short]").change(function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,
e){for(;;)switch(c){case 0:if(a.value==d.data()["short"]){c=1;break}c=2;return{value:checkShortCodeInput(a),done:!1};case 2:if(void 0===e){c=3;break}c=-1;throw e;case 3:case 1:c=-1;default:return{value:void 0,done:!0}}}var c=0,e={next:function(a){return b(a,void 0)},"throw":function(a){return b(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();e[Symbol.iterator]=function(){return this};return e}())});$("#register").submit(function(a){!1===this.checkValidity()?
(a.preventDefault(),a.stopPropagation()):updateShopSettings(a,d);$(this).addClass("was-validated")})})});renderLinks(d);e=-1;default:return{value:void 0,done:!0}}}var e=0,b,c,d,m,g,n={next:function(b){return a(b,void 0)},"throw":function(b){return a(void 0,b)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();n[Symbol.iterator]=function(){return this};return n}())});
function updateShopSettings(a,e){return $jscomp.executeAsyncGenerator(function(){function b(b,p){for(;;)switch(c){case 0:return a.preventDefault(),z=$("#name").val(),A=$("#address").val(),B=$("#short").val(),C=$("#mon-open").val(),D=$("#mon-close").val(),u=$("#tue-open").val(),t=$("#tue-close").val(),y=$("#wed-open").val(),w=$("#wed-close").val(),x=$("#thu-open").val(),v=$("#thu-close").val(),q=$("#fri-open").val(),f=$("#fri-close").val(),r=$("#sat-open").val(),l=$("#sat-close").val(),h=$("#sun-open").val(),
k=$("#sun-close").val(),n=parseInt($("#number").val()),g=parseInt($("#rate").val()),$("#email").val(),m="true"==$("input[name=control]:checked").val()?!0:!1,d={name:z,address:A,"short":B,hours:{mon:$("#mon-closed").prop("checked")?"closed":{open:C,close:D},tue:$("#tue-closed").prop("checked")?"closed":{open:u,close:t},wed:$("#wed-closed").prop("checked")?"closed":{open:y,close:w},thu:$("#thu-closed").prop("checked")?"closed":{open:x,close:v},fri:$("#fri-closed").prop("checked")?"closed":{open:q,close:f},
sat:$("#sat-closed").prop("checked")?"closed":{open:r,close:l},sun:$("#sun-closed").prop("checked")?"closed":{open:h,close:k}},bookings:{number:n,rate:g},control:m},console.log(d),c=1,{value:db.collection("shops").doc(e.id).update(d).then(function(){location.reload()})["catch"](function(a){console.error("Error updating shop settings: ",a);$(".btn").css("background-color","red").text("Shop settings update failed")}),done:!1};case 1:if(void 0===p){c=2;break}c=-1;throw p;case 2:c=-1;default:return{value:void 0,
done:!0}}}var c=0,d,m,g,n,k,h,l,r,f,q,v,x,w,y,t,u,D,C,B,A,z,p={next:function(a){return b(a,void 0)},"throw":function(a){return b(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();p[Symbol.iterator]=function(){return this};return p}())}
function renderShopSettings(a){$("#shop-settings > > #name").text(a.data().name);$("#shop-settings > > #address").text(a.data().address);$("#shop-settings > > #short").text(a.data()["short"]);$.each(a.data().hours,function(a,b){"closed"==b?$("#shop-settings > > #hours > > #"+a).text("Closed"):$("#shop-settings > > #hours > > #"+a).text(b.open+" to "+b.close)});$("#shop-settings > > #options").append("<p>Accepting "+a.data().bookings.number+" bookings every "+a.data().bookings.rate+" minutes.</p>");
1==a.data().control?$("#shop-settings > > #options").append("<p>Customers with bookings will have priority, those without can still walk-in.</p>"):$("#shop-settings > > #options").append("<p>My shop only accepts customers with a booking.</p>")}
function updateShopQueueStatus(a,e){return $jscomp.executeAsyncGenerator(function(){function b(b,h){for(;;)switch(c){case 0:try{return c=3,{value:db.collection("shops").doc(a.id),done:!1}}catch(f){k=f;c=1;break}case 3:try{if(void 0===h){c=4;break}c=-1;throw h;}catch(f){k=f;c=1;break}case 4:try{return g=n=b,c=5,{value:g.update({status:e}),done:!1}}catch(f){k=f;c=1;break}case 5:try{if(void 0===h){c=6;break}c=-1;throw h;}catch(f){k=f;c=1;break}case 6:try{return console.log("Shop queue status successfully updated!"),
c=7,{value:g.get(),done:!1}}catch(f){k=f;c=1;break}case 7:try{if(void 0===h){c=8;break}c=-1;throw h;}catch(f){k=f;c=1;break}case 8:try{return a=m=b,c=-1,{value:a,done:!0}}catch(f){k=f;c=1;break}case 1:d=k,console.error("Error updating shop: ",d);case 2:c=-1;default:return{value:void 0,done:!0}}}var c=0,d,m,g,n,k,h={next:function(a){return b(a,void 0)},"throw":function(a){return b(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();h[Symbol.iterator]=
function(){return this};return h}())}
function renderQueue(a,e){1==a.control?$("#toggle-queue").show():$("#toggle-queue").hide();var b=e.find(function(a){return moment(a.data().time,"HH:mm")>=moment()});console.log("Queue status",a.status);$("#queue-status").parent().removeClass("d-none");"auto"==a.status?void 0!=b&&2>moment.duration(moment(b.data().time,"HH:mm")-moment()).asMinutes()?(console.log("Next booking",b.data().time),$("#queue-status").find("h1").text("#"+b.data().time.replace(":","")),$("#queue-status").find("h1").parent().css("background-color",b.data().color),
$("#queue-status").find("h1").removeClass("text-white text-dark").addClass(lightOrDark(b.data().color)?"text-dark":"text-white")):($("#queue-status").find("h1").text("PLEASE WAIT").removeClass("text-white text-dark").addClass("text-dark"),$("#queue-status").find("h1").parent().css("background-color","#f8ad17")):($("#queue-status").find("h1").text("NEXT CUSTOMER").removeClass("text-white text-dark").addClass("text-white"),$("#queue-status").find("h1").parent().css("background-color","#7bd118"))}
function renderBookings(a){var e=a.find(function(a){return moment(a.data().time,"HH:mm")>=moment()});$("#all-bookings").empty();a.forEach(function(a){moment(a.data().time,"HH:mm")<moment()?$("#all-bookings").append('<div class="col-4 col-xl-3 p-2 mb-2 d-flex justify-content-center"><label class="w-100 btn btn-grey nohover btn-lg">#'+a.data().time.replace(":","")+"</label></div>"):a.data().time==e.data().time&&2>moment.duration(moment(e.data().time,"HH:mm")-moment()).asMinutes()?$("#all-bookings").append('<div class="col-4 col-xl-3 p-2 mb-2 d-flex justify-content-center"><label class="w-100 font-weight-bold btn nohover btn-outline-dark btn-lg" style="box-shadow: 0 0 0 5px '+
a.data().color+'; border-color: transparent">#'+a.data().time.replace(":","")+"</label></div>"):$("#all-bookings").append('<div class="col-4 col-xl-3 p-2 mb-2 d-flex justify-content-center"><label class="w-100 font-weight-bold btn btn-outline-dark nohover btn-lg">#'+a.data().time.replace(":","")+"</label></div>")})}
function makeSchedulePDF(a,e){var b=new jsPDF;b.setFont("open-sans","bold");var c=0;new QRCode(document.getElementById("qrcode"),"https://conga.store/"+a.data()["short"]);$("#qrcode > img ").on("load",function(){e.forEach(function(d,e){var g=e%4;b.setFillColor(d.data().color);b.roundedRect(20+45*g,90+25*c,35,15,1,1,"F");b.setFontStyle("bold");b.setFontSize(20);b.setTextColor(lightOrDark(d.data().color)?0:255);b.text("#"+d.data().time.replace(":",""),26.5+45*g,100+25*c);0==(g+1)%4&&(c+=1,0==c%5&&(b.addPage("a4",
"p"),c=0));0==c&&0==g&&(console.log("new page"),b.setTextColor("#000000"),b.setFontStyle("bold"),b.setFontSize(20),b.text(a.data().name,105,20,{align:"center"}),b.setFontStyle("regular"),b.setFontSize(18),b.text("Don\u2019t want to queue?",105,30,{align:"center"}),b.text("We now offer a",87,40,{align:"right"}),b.setTextColor("#e40053"),b.setFontStyle("bold"),b.text("priority booking service",90,40,{align:"left"}),b.setTextColor("#000000"),b.setFontStyle("regular"),b.setFontSize(14),b.text("(in addition of regular queuing for walk-ins)",
105,50,{align:"center"}),b.text("Bookings for",95,80,{align:"right"}),b.setFontStyle("bold"),b.text(moment().format("dddd Do MMMM"),97,80,{align:"left"}),g=new Image,g.src="/assets/conga.png",b.addImage(g,"png",8,266,34.7,23),b.setFontSize(14),b.setFontStyle("regular"),b.text("To book for tomorrow:",52,268),b.setFontStyle("bold"),b.text("go to",52,275),b.setTextColor("#e40053"),b.text("conga.store",66,275),b.setTextColor("#000000"),b.text("/"+a.data()["short"],95,275),b.setFontSize(12),b.text("Fast, Free & Simple!",
52,284),b.setFontStyle("regular"),b.text("No need to register \u2022 No app to install \u2022 No data collected",52,290),b.addImage($("#qrcode > img ").attr("src"),176,264,26,26))})});$("#get-schedule").removeClass("d-none").on("click",function(){b.save("schedule.pdf")})}
function renderLinks(a){new ClipboardJS("#booking-link");$("#booking-link").attr("data-clipboard-text","https://conga.store/book?shop="+a.data().code);new ClipboardJS("#queue-link");$("#queue-link").attr("data-clipboard-text","https://conga.store/queue?key="+a.id)};
