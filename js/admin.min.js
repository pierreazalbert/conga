var $jscomp={scope:{},executeAsyncGenerator:function(a){function b(b){return a.next(b)}function c(b){return a["throw"](b)}return new Promise(function(d,e){function l(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(l,e)}l(a.next())})}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.EXPOSE_ASYNC_EXECUTOR=!0;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var l=a[e];if(b.call(c,l,e,a))return{i:e,v:l}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
$(document).ready(function(){return $jscomp.executeAsyncGenerator(function(){function a(a,g){for(;;)switch(b){case 0:return m=getParams(window.location.href).key,b=1,{value:getShopData(m),done:!1};case 1:if(void 0===g){b=2;break}b=-1;throw g;case 2:return e=l=a,$("#shop-name").text(e.data().name),$("#shop-code").prepend("Shop ID: "+e.data().code[0]+"-"+e.data().code[1]+"-"+e.data().code[2]+"-"+e.data().code[3]),$("#shop-link").prop("href","/book?shop="+e.data().code),$("[name=today]").text(moment().format("dddd Do MMMM")),
b=3,{value:db.collection("tickets").where("shop","==",e.id).where("date","==",moment().format("DD/MM/YYYY")).get(),done:!1};case 3:if(void 0===g){b=4;break}b=-1;throw g;case 4:c=d=a;if(c.empty)console.log("No bookings found for this shop!"),$("#all-bookings").empty().append('<div class="col-12 mb-2 d-flex justify-content-center"><label class="w-100 btn btn-grey btn-conga nohover btn-lg">No bookings found for today</label></div>'),$("#get-schedule").hide();else{console.log("Found following bookings: ",
c.docs);var k=c.docs.slice();k.sort(function(a,b){return moment(a.data().time,"HH:mm")-moment(b.data().time,"HH:mm")});renderQueue(e.data(),k);renderBookings(k);makeSchedulePDF(k);if("auto"==e.data().status){$("#next-booking").click();var h=setInterval(function(){renderQueue(e.data(),k);renderBookings(k)},1E4)}else $("#next-customer").click()}$("#toggle-queue").change(function(a){return $jscomp.executeAsyncGenerator(function(){function a(a,f){for(;;)switch(b){case 0:if("next-booking"!=$(":checked").attr("id")){b=
1;break}console.log("Switching to automatic queue control");b=3;return{value:updateShopQueueStatus(e,"auto"),done:!1};case 3:if(void 0===f){b=4;break}b=-1;throw f;case 4:e=d=a;renderQueue(e.data(),k);renderBookings(k);h=setInterval(function(){renderQueue(e.data(),k);renderBookings(k)},1E4);b=2;break;case 1:if("next-customer"!=$(":checked").attr("id")){b=5;break}console.log("Switching to manual queue control");b=6;return{value:updateShopQueueStatus(e,"manual"),done:!1};case 6:if(void 0===f){b=7;break}b=
-1;throw f;case 7:e=c=a,renderQueue(e.data(),k),clearInterval(h);case 5:case 2:b=-1;default:return{value:void 0,done:!0}}}var b=0,c,d,f={next:function(b){return a(b,void 0)},"throw":function(b){return a(void 0,b)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())});renderShopSettings(e);$(":button[name=settings]").click(function(){$("#shop-settings").load("register.html form",function(){$("#shop-settings").addClass("mb-5");
$("form > :submit").text("Save shop settings");$("form").find("#email").parent().parent().prev().remove();$("form").find("#email").parent().parent().next().remove();$("form").find("#email").parent().parent().remove();$("form").find(".text-muted").remove();$(":checkbox").change(function(){$(this).parent().parent().parent().find("input[type='time']").prop("disabled",function(a,b){return!b})});$("form").find("#name").val(e.data().name);$("form").find("#address").val(e.data().address);$("form").find("#short").val(e.data()["short"]);
$.each(e.data().hours,function(a,b){"closed"==b?$("form").find("#"+a+"-closed").click():($("form").find("#"+a+"-open").val(b.open),$("form").find("#"+a+"-close").val(b.close))});$("form").find("#number").val(e.data().bookings.number);$("form").find("#rate").val(e.data().bookings.rate);$("form").find("input[name=control][value="+e.data().control+"]").prop("checked",!0);$("input[type=time]").change(function(){checkTimeInput(this)});$("input[id=short]").change(function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,
d){for(;;)switch(c){case 0:if(a.value==e.data()["short"]){c=1;break}c=2;return{value:checkShortCodeInput(a),done:!1};case 2:if(void 0===d){c=3;break}c=-1;throw d;case 3:case 1:c=-1;default:return{value:void 0,done:!0}}}var c=0,d={next:function(a){return b(a,void 0)},"throw":function(a){return b(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();d[Symbol.iterator]=function(){return this};return d}())});$("#register").submit(function(a){!1===this.checkValidity()?
(a.preventDefault(),a.stopPropagation()):updateShopSettings(a,e);$(this).addClass("was-validated")})})});renderLinks(e);b=-1;default:return{value:void 0,done:!0}}}var b=0,c,d,e,l,m,n={next:function(b){return a(b,void 0)},"throw":function(b){return a(void 0,b)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();n[Symbol.iterator]=function(){return this};return n}())});
function updateShopSettings(a,b){return $jscomp.executeAsyncGenerator(function(){function c(c,p){for(;;)switch(d){case 0:return a.preventDefault(),z=$("#name").val(),A=$("#address").val(),B=$("#short").val(),C=$("#mon-open").val(),D=$("#mon-close").val(),u=$("#tue-open").val(),t=$("#tue-close").val(),y=$("#wed-open").val(),w=$("#wed-close").val(),x=$("#thu-open").val(),v=$("#thu-close").val(),q=$("#fri-open").val(),f=$("#fri-close").val(),r=$("#sat-open").val(),k=$("#sat-close").val(),g=$("#sun-open").val(),
h=$("#sun-close").val(),n=parseInt($("#number").val()),m=parseInt($("#rate").val()),$("#email").val(),l="true"==$("input[name=control]:checked").val()?!0:!1,e={name:z,address:A,"short":B,hours:{mon:$("#mon-closed").prop("checked")?"closed":{open:C,close:D},tue:$("#tue-closed").prop("checked")?"closed":{open:u,close:t},wed:$("#wed-closed").prop("checked")?"closed":{open:y,close:w},thu:$("#thu-closed").prop("checked")?"closed":{open:x,close:v},fri:$("#fri-closed").prop("checked")?"closed":{open:q,close:f},
sat:$("#sat-closed").prop("checked")?"closed":{open:r,close:k},sun:$("#sun-closed").prop("checked")?"closed":{open:g,close:h}},bookings:{number:n,rate:m},control:l},console.log(e),d=1,{value:db.collection("shops").doc(b.id).update(e).then(function(){location.reload()})["catch"](function(a){console.error("Error updating shop settings: ",a);$(".btn").css("background-color","red").text("Shop settings update failed")}),done:!1};case 1:if(void 0===p){d=2;break}d=-1;throw p;case 2:d=-1;default:return{value:void 0,
done:!0}}}var d=0,e,l,m,n,h,g,k,r,f,q,v,x,w,y,t,u,D,C,B,A,z,p={next:function(a){return c(a,void 0)},"throw":function(a){return c(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();p[Symbol.iterator]=function(){return this};return p}())}
function renderShopSettings(a){$("#shop-settings > > #name").text(a.data().name);$("#shop-settings > > #address").text(a.data().address);$("#shop-settings > > #short").text(a.data()["short"]);$.each(a.data().hours,function(a,c){"closed"==c?$("#shop-settings > > #hours > > #"+a).text("Closed"):$("#shop-settings > > #hours > > #"+a).text(c.open+" to "+c.close)});$("#shop-settings > > #options").append("<p>Accepting "+a.data().bookings.number+" bookings every "+a.data().bookings.rate+" minutes.</p>");
1==a.data().control?$("#shop-settings > > #options").append("<p>Customers with bookings will have priority, those without can still walk-in.</p>"):$("#shop-settings > > #options").append("<p>My shop only accepts customers with a booking.</p>")}
function updateShopQueueStatus(a,b){return $jscomp.executeAsyncGenerator(function(){function c(c,g){for(;;)switch(d){case 0:try{return d=3,{value:db.collection("shops").doc(a.id),done:!1}}catch(f){h=f;d=1;break}case 3:try{if(void 0===g){d=4;break}d=-1;throw g;}catch(f){h=f;d=1;break}case 4:try{return m=n=c,d=5,{value:m.update({status:b}),done:!1}}catch(f){h=f;d=1;break}case 5:try{if(void 0===g){d=6;break}d=-1;throw g;}catch(f){h=f;d=1;break}case 6:try{return console.log("Shop queue status successfully updated!"),
d=7,{value:m.get(),done:!1}}catch(f){h=f;d=1;break}case 7:try{if(void 0===g){d=8;break}d=-1;throw g;}catch(f){h=f;d=1;break}case 8:try{return a=l=c,d=-1,{value:a,done:!0}}catch(f){h=f;d=1;break}case 1:e=h,console.error("Error updating shop: ",e);case 2:d=-1;default:return{value:void 0,done:!0}}}var d=0,e,l,m,n,h,g={next:function(a){return c(a,void 0)},"throw":function(a){return c(void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();g[Symbol.iterator]=
function(){return this};return g}())}
function renderQueue(a,b){1==a.control?$("#toggle-queue").show():$("#toggle-queue").hide();var c=b.find(function(a){return moment(a.data().time,"HH:mm")>=moment()});console.log("Queue status",a.status);$("#queue-status").parent().removeClass("d-none");"auto"==a.status?void 0!=c&&2>moment.duration(moment(c.data().time,"HH:mm")-moment()).asMinutes()?(console.log("Next booking",c.data().time),$("#queue-status").find("h1").text("#"+c.data().time.replace(":","")),$("#queue-status").find("h1").parent().css("background-color",c.data().color),
$("#queue-status").find("h1").removeClass("text-white text-dark").addClass(lightOrDark(c.data().color)?"text-dark":"text-white")):($("#queue-status").find("h1").text("PLEASE WAIT").removeClass("text-white text-dark").addClass("text-dark"),$("#queue-status").find("h1").parent().css("background-color","#f8ad17")):($("#queue-status").find("h1").text("NEXT CUSTOMER").removeClass("text-white text-dark").addClass("text-white"),$("#queue-status").find("h1").parent().css("background-color","#7bd118"))}
function renderBookings(a){var b=a.find(function(a){return moment(a.data().time,"HH:mm")>=moment()});$("#all-bookings").empty();a.forEach(function(a){moment(a.data().time,"HH:mm")<moment()?$("#all-bookings").append('<div class="col-4 col-xl-3 p-2 mb-2 d-flex justify-content-center"><label class="w-100 btn btn-grey nohover btn-lg">#'+a.data().time.replace(":","")+"</label></div>"):a.data().time==b.data().time&&2>moment.duration(moment(b.data().time,"HH:mm")-moment()).asMinutes()?$("#all-bookings").append('<div class="col-4 col-xl-3 p-2 mb-2 d-flex justify-content-center"><label class="w-100 font-weight-bold btn nohover btn-outline-dark btn-lg" style="box-shadow: 0 0 0 5px '+
a.data().color+'; border-color: transparent">#'+a.data().time.replace(":","")+"</label></div>"):$("#all-bookings").append('<div class="col-4 col-xl-3 p-2 mb-2 d-flex justify-content-center"><label class="w-100 font-weight-bold btn btn-outline-dark nohover btn-lg">#'+a.data().time.replace(":","")+"</label></div>")})}
function makeSchedulePDF(a){var b=new jsPDF;b.setFontSize(25);b.text(moment().format("dddd Do MMMM"),20,20);b.setFontSize(20);var c=0;a.forEach(function(a,e){var d=e%5;b.setFillColor(a.data().color);b.roundedRect(20+35*d,30+20*c,30,15,3,3,"F");b.setFontStyle("bold");b.setTextColor(lightOrDark(a.data().color)?0:255);b.text(a.data().time,26+35*d,40+20*c);0==(d+1)%5&&(c+=1)});$("#get-schedule").on("click",function(){b.save("schedule.pdf")})}
function renderLinks(a){new ClipboardJS("#booking-link");$("#booking-link").attr("data-clipboard-text","https://conga.store/book?shop="+a.data().code);new ClipboardJS("#queue-link");$("#queue-link").attr("data-clipboard-text","https://conga.store/display?key="+a.id);new QRCode(document.getElementById("qrcode"),"https://conga.store/book?shop="+a.data().code);$("#qrcode > img ").on("load",function(){var b=new jsPDF;b.setFontSize(40);b.text("Book your visit",30,30);b.text("with Conga",30,50);b.addImage(this.src,
30,100,100,100);b.text("www.conga.store/"+a.data().code,30,250);$("#get-poster").on("click",function(){b.save("Shop poster ("+a.data().code[0]+"-"+a.data().code[1]+"-"+a.data().code[2]+"-"+a.data().code[3]+")")})})};
